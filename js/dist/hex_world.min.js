/*
hex_world 0.1.0
Mois Moshev <mois@monomon.me>
2015-05-09
*/
var utils={drawRegularPoly:function(a,b,c,d){for(var e=[],f=2*Math.PI/b,g=f/2,h=0;b>h;h++)e.push([Math.round(d*Math.cos(g))-.5,Math.round(d*Math.sin(g))-.5]),g+=f;return a.polygon(e).transform({x:c[0],y:c[1]})},drawHex:function(a,b,c){return utils.drawRegularPoly(a,6,b,c)},hexBounds:function(a){return{width:a*Math.sqrt(3),height:2*a}},hsvToRgb:function(a){var b,c=a.v*a.s,d=.75*Math.PI*.5,e=2*Math.PI*a.h,f=c*(1-Math.abs(e/d%2-1)),g=a.v-c;switch(Math.floor(e/d)){case 0:b=[c,f,0];break;case 1:b=[f,c,0];break;case 2:b=[0,c,f];break;case 3:b=[0,f,c];break;case 4:b=[f,0,c];break;case 5:b=[c,0,f]}return{r:Math.floor(255*(b[0]+g)),g:Math.floor(255*(b[1]+g)),b:Math.floor(255*(b[2]+g))}},cubeToOffset:function(a){return[a[0]+(a[2]-(1&a[2]))/2,a[2]]},offsetToCube:function(a){var b=[a[0]-(a[1]-(1&a[1]))/2,0,a[1]];return b[1]=-1*b[0]-b[2],b},getLogistic:function(a,b,c,d,e){return a+(b-a)/Math.pow(1+Math.exp(-c*e),1/d)},getParameters:function(a){for(var b={},c=0,d=a.elements.length;d>c;c++){var e=a.elements[c];e.name&&"submit"!==e.type&&(b[e.name]="radio"==e.type||"checkbox"==e.type?"checked"==e.checked:encodeURIComponent(e.value))}return b},getParameterByName:function(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}},Tile={init:function(a){return this.value=a.value,this.gridPos=a.gridPos,this.el=a.el,this}},HexGrid={propsToCopy:["width","height","tileRadius","wrapX"],tileStroke:"#ffffff",init:function(a){for(var b=this.propsToCopy.length-1;b>=0;b--){var c=this.propsToCopy[b];a[c]&&(this[c]=a[c])}console.assert(this.width),console.assert(this.height),console.assert(this.tileRadius),this.hexBounds=utils.hexBounds(this.tileRadius),this.ctx=SVG(a.elId),this.tilesGroup=this.ctx.group(),this.tilesGroup.addClass("tilesGroup"),this.ctx.size(this.hexBounds.width*this.width+this.hexBounds.width,this.hexBounds.height*this.height),this.elToTile=new WeakMap,this.tiles=[];for(var b=0;b<this.width*this.height;b++)this.createTile(b);return this},createTile:function(a){var b=this.createRandomTile(a),c=this.tiles.push(b);return this.elToTile.set(b.el,b),c},drawTile:function(a){var b=new SVG.Color({r:a.value,g:a.value,b:a.value}),c=this.gridToCoords(a.gridPos);return utils.drawHex(this.tilesGroup,c,this.tileRadius).addClass("hex").style({fill:b.toHex(),stroke:this.tileStroke})},gridToCoords:function(a){var b=a[1]%2!==0?.5:0;return[(a[0]%this.width+b+.5)*this.hexBounds.width+1,.75*a[1]*this.hexBounds.height+.5*this.hexBounds.height+1]},getRandomTile:function(){return this.tiles[Math.floor(Math.random()*this.tiles.length)]},createRandomTile:function(a){var b=Math.random(),c=Object.create(Tile).init({value:Math.floor(200*b+(b>.5?55:25*Math.random())),gridPos:[a%this.width,Math.floor(a/this.width)]});return c.el=this.drawTile(c),c},getNeighbors:function(a){for(var b=[],c=utils.offsetToCube(a.gridPos),d=0;3>d;d++)for(var e=1;3>e;e++){var f=c.slice(0);f[d]+=1,f[Number((d+e)%f.length)]-=1;var g=utils.cubeToOffset(f);if(this.wrapX)g[0]<0?g[0]+=this.width:g[0]>=this.width&&(g[0]-=this.width);else if(g[0]<0||g[0]>=this.width)continue;var h=this.tiles[g[1]*this.width+g[0]];h&&b.indexOf(h)<0&&b.push(h)}return b}},HexWorld={tileElToTribe:void 0,populationInitModifier:150,maxPopulation:255,init:function(a){return this.grid=Object.create(HexGrid).init(a),this.startTime=null,this.initTribes(a),this.lastConfig=a,this},initTribes:function(a){this.tileElToTribe=new WeakMap,this.tribes=[];for(var b=0;b<a.numTribes;b++)this.addTribe(this.createRandomTribe())},createRandomTribe:function(){return Object.create(Tribe).init({population:this.getRandomPopulation(),culture:Math.random(),tile:this.getRandomUnoccupiedTile(),world:this})},addTribe:function(a){this.tribes.push(a),this.tileElToTribe.set(a.tile.el,a),a.tile.el.addClass("occupied"),a.draw()},removeTribe:function(a){this.tribes.splice(this.tribes.indexOf(a),1),this.tileElToTribe["delete"](a.tile.el)},getRandomUnoccupiedTile:function(){for(var a=this.grid.getRandomTile();void 0!==this.tileElToTribe.get(a.el);)a=this.grid.getRandomTile();return a},getRandomPopulation:function(){return Math.floor(.5*(.5+Math.random())*this.populationInitModifier)},update:function(a){for(var b,c=0;c<this.tribes.length;c++)b=this.tribes[c],b.decide(a);for(var c=0;c<this.tribes.length;c++)b=this.tribes[c],b.population<=0?(b.die(),this.removeTribe(b)):b.draw()},play:function(){var a=this;!function b(c){a.update.call(a,c),null===a.startTime&&(a.startTime=c),a.animRequestId=requestAnimationFrame(b)}(0)},stop:function(){cancelAnimationFrame(this.animRequestId)},reset:function(){cancelAnimationFrame(this.animRequestId),this.clear(),this.init(this.lastConfig),this.startTime=0},clear:function(){this.grid.ctx.clear(),this.grid.tiles=[],this.tribes=[],this.tileElToTribe=void 0,this.grid.ctx.node.remove()}},WorldControls={init:function(a){this.world=a.world,this.rootEl=a.rootEl,this.outputEl=a.outputEl,this.initControls(a)},initControls:function(a){function b(a){Tribe[a.target.name]=a.target.value}function c(){var a=document.getElementById("worldCreateForm");a.style.display="block"}var d=this.rootEl.querySelector("[name=start]");this.outputEl;d.addEventListener("click",function(){a.world.play.call(a.world)});var e=this.rootEl.querySelector("[name=stop]");e.addEventListener("click",function(){a.world.stop.call(a.world)});var f=this.rootEl.querySelector("[name=reset]");f.addEventListener("click",function(){a.world.reset.call(a.world)});for(var g=this.rootEl.querySelectorAll('#tribeConfig input[type="number"]'),h=0;h<g.length;h++){var i=g.item(h);i.value=Tribe[i.name],i.addEventListener("change",b)}var j=this.rootEl.querySelector('#tribeConfig input[name="showText"]'),k=this.world;j.addEventListener("click",function(a){if(!Tribe.showTextFlag&&a.target.checked)for(var b=0;b<k.tribes.length;b++)k.tribes[b].showText();else if(Tribe.showTextFlag&&!a.target.checked)for(var b=0;b<k.tribes.length;b++)k.tribes[b].hideText();Tribe.showTextFlag=a.target.checked}),Tribe.showTextFlag=j.checked,this.rootEl.querySelector(".handle").addEventListener("click",function(a){$("#tribeConfig").toggle(),$(a.target).toggleClass("active")});var l=this.rootEl.querySelector("button[name=newGrid]");l.addEventListener("click",function(a){k.clear(),c()})}},Tribe={maxGrowth:1.1,maxStarve:-.9,growthRate:1.5,growthAsymptote:.5,decisionPeriod:1500,colonyPopulationFraction:.3,maxPatience:500,showTextFlag:!1,init:function(a){console.assert(a.tile,"tile expected in config"),this.world=a.world,this.population=a.population,this.tile=a.tile,this.culture=a.culture,this.group=this.tile.el.parent.group(),this.group.addClass("tribe"+this.population.toFixed(2)),this.mask=this.tile.el.clone(),this.mask.addClass("tribe"),this.group.add(this.mask),this.text=this.group.text(""),this.lastDecision=0,this.temperature=0,this.lastConfig=a,this.patience=a.patience||(.8*Math.random()+.2)*this.maxPatience;var b=this.world.grid.gridToCoords(this.tile.gridPos);return this.group.transform({x:b[0],y:b[1]}),this.mask.transform({x:0,y:0}),this},getColor:function(){return new SVG.Color(utils.hsvToRgb({h:this.culture,s:this.population/HexWorld.maxPopulation*.8+.1,v:this.patience/this.maxPatience*.8+.2}))},draw:function(){var a=this.getColor();this.mask.style({fill:a.toHex()}),this.showTextFlag&&this.text.text(this.getText())},getText:function(){var a=["p:"+this.population,"t:"+this.temperature];return a.join("\n")},hideText:function(){this.text.hide()},showText:function(){this.text.show()},decide:function(a){if(this.population=Math.min(this.population+Math.floor(this.getGrowth(this.tile)*this.population),HexWorld.maxPopulation),a-this.lastDecision<Tribe.decisionPeriod)return void(this.temperature+=1);var b=[],c=this.calculateGain(this.tile);b.push({gain:c,tile:this.tile});var d=this.getNeighbors(),e=this;if(b=d.reduce(function(a,b){return a&&b.value&&a.push({gain:e.calculateGain(b),tile:b}),a},b),b=b.sort(function(a,b){return b.gain-a.gain}),this.temperature>this.patience||b[0].gain>c)for(var f=0;f<b.length;f++)if(b[f].tile===this.tile||this.world.tileElToTribe.has(b[f].tile.el))this.temperature=0;else{if(b[f].gain>c||Math.random()>.8)return this.move(b[f].tile),this.lastDecision=a,void(this.temperature=0);if(this.population>=.7*HexWorld.maxPopulation||b[f].gain>=c)return this.colonize(b[f].tile),this.lastDecision=a,void(this.temperature=0)}this.temperature+=1},die:function(){this.neighborsGroup&&this.neighborsGroup.remove(),this.group.remove()},move:function(a){console.assert(this.tile!==a),console.assert(!this.world.tileElToTribe.has(a.el)),this.tile.el.removeClass("occupied"),this.world.tileElToTribe["delete"](this.tile.el);var b=this.world.grid.gridToCoords(a.gridPos);this.group.transform({x:b[0],y:b[1]}),this.tile=a,this.world.tileElToTribe.set(this.tile.el,this)},colonize:function(a){console.assert(this.tile!==a),console.assert(!this.world.tileElToTribe.has(a.el));var b=Object.create(this.lastConfig);b.tile=a,b.world=this.world,b.population=Math.floor(Tribe.colonyPopulationFraction*this.population),b.culture=this.culture,b.patience=this.patience,b.temperature=0;var c=Object.create(Tribe).init(b);this.world.addTribe(c),c.draw(),this.population=Math.floor((1-Tribe.colonyPopulationFraction)*this.population)},calculateGain:function(a){var b=this.getGrowth(a);return b},getGrowth:function(a){return utils.getLogistic(Tribe.maxStarve,Tribe.maxGrowth,Tribe.growthRate,Tribe.growthAsymptote,Math.sqrt(a.value*this.population)/HexWorld.maxPopulation)},getNeighbors:function(){return this.world.grid.getNeighbors(this.tile)},markNeighbors:function(){var a=this.getNeighbors();this.neighborsGroup||(this.neighborsGroup=this.world.grid.ctx.group());for(var b=0;b<a.length;b++)if(!this.world.tileElToTribe.has(a[b].el)){var c=a[b].el.clone();this.neighborsGroup.addClass("neighborOverlay"),this.neighborsGroup.add(c),c.style({fill:"#a11",opacity:.2})}},unmarkNeighbors:function(){this.neighborsGroup&&this.neighborsGroup.clear()}};